# PRD-0010 Checklist: NAS SMB 연동

**상태**: 🔴 BLOCKED (반복 실패 중)

## Phase 1: 인프라 설정 (Critical) - 🔴 BLOCKED

### NAS 측 (Synology DSM)
- [x] SMB 서비스 활성화 (smbd 프로세스 확인됨)
- [ ] 최대 SMB 프로토콜: SMB3 설정 확인 필요
- [x] 공유 폴더 `docker` 생성/확인 (smb.share.conf 확인됨)
- [x] 하위 폴더 생성: `/volume1/docker/pokergfx/hands` (SSH 확인됨)
- [ ] 사용자 권한 설정 확인 필요
- [ ] 방화벽 규칙 확인 필요

### Windows 측
- [x] 자격 증명 저장됨 (GGP 사용자)
- [ ] 🔴 연결 테스트: `net use \\NAS_IP\docker` → **System error 67 반복**
- [ ] 파일 쓰기 테스트 (연결 실패로 불가)

### PokerGFX 설정
- [ ] JSON Export Path 설정 (연결 실패로 불가)
- [ ] Auto Export 활성화 (연결 실패로 불가)
- [ ] 테스트 핸드 생성 (연결 실패로 불가)

---

## Phase 2: 코드 개선 (완료)

- [x] 파일 락 재시도 로직 (`json_file_watcher.py`) (#5)
- [x] 설정 검증 강화 (`settings.py`) (#5)
- [x] `_wait_for_file_ready()` 메서드 추가
- [x] `model_validator` 추가

### Phase 2.5: 하이브리드 대책 (완료)

- [x] SMB Health Checker 모듈 (`smb_health_checker.py`)
- [x] Fallback Watcher 모듈 (`fallback_watcher.py`)
- [x] 3단계 연결 검증 (`_check_nas_connection()` 강화)
- [x] 자동 재연결 로직 (지수 백오프)
- [x] Fallback 설정 추가 (`settings.py`)
- [x] main.py 통합
- [x] 수동 Import UI (Streamlit)
- [x] 인프라 체크리스트 (`docs/NAS_SMB_CHECKLIST.md`)
- [x] 통합 테스트 (`tests/test_smb_fallback.py`)

---

## Phase 3: 문서화 (완료)

- [x] NAS 설정 가이드 (`docs/NAS_SETUP.md`)
- [x] 이슈 업데이트 가이드 (`docs/ISSUE_UPDATE_GUIDE.md`)
- [x] PRD-0010 작성 (`tasks/prds/PRD-0010-nas-smb-integration.md`)

---

## Phase 4: 통합 테스트

### 테스트 시나리오
- [ ] Windows → NAS 파일 쓰기 테스트
- [ ] Docker 컨테이너 파일 감지 테스트
- [ ] 파일 락 상황 시뮬레이션
- [ ] 연결 끊김/재연결 테스트

### 검증 항목
- [ ] 파일 처리 지연 < 5초
- [ ] 파일 락 재시도 정상 동작
- [ ] 중복 파일 감지 정상 동작
- [ ] 로그 출력 확인

---

## 진행 상황

| 날짜 | 작업 | 결과 | 담당 |
|------|------|------|------|
| 2026-01-09 | GitHub 이슈 #5 생성 | ✅ 완료 | Claude |
| 2026-01-09 | 코드 개선 (파일 락, 설정 검증) | ✅ 완료 | Claude |
| 2026-01-09 | 문서 작성 (NAS_SETUP, ISSUE_UPDATE_GUIDE) | ✅ 완료 | Claude |
| 2026-01-09 | PRD-0010 작성 | ✅ 완료 | Claude |
| 2026-01-09 | NAS ping 테스트 | ✅ 성공 | Claude |
| 2026-01-09 | SMB 포트 445 테스트 | ✅ 열림 | Claude |
| 2026-01-09 | NAS SMB 서비스 확인 | ✅ 실행 중 | Claude |
| 2026-01-09 | 공유 폴더/경로 SSH 확인 | ✅ 존재함 | Claude |
| 2026-01-09 | `net use` 연결 시도 | ❌ error 67 | Claude |
| 2026-01-09 | 다른 공유 폴더 시도 | ❌ error 67 | Claude |
| - | NAS DSM SMB 고급 설정 확인 | 🔴 대기 | 인프라 |
| - | Windows 탐색기 직접 접근 | 🔴 대기 | 인프라 |
| - | 통합 테스트 | ⏳ 대기 | 개발 |

---

## 🔴 BLOCKED 원인 분석

### 확인된 정상 항목
- NAS ping 응답 (TTL=64, <1ms)
- SMB 포트 445 열림 (TcpTestSucceeded=True)
- NAS smbd 프로세스 다수 실행 중
- 공유 폴더 설정 존재 (`docker` → `/volume1/docker`)
- 폴더 구조 정상 (`/volume1/docker/pokergfx/hands`)
- Windows 자격 증명 저장됨 (GGP)

### 추정 원인
1. **Windows SMB 서명 불일치**: `RequireSecuritySignature=True`
2. **NAS SMB 프로토콜 버전 제한**
3. **NAS 방화벽 규칙 (특정 IP 허용)**

### 필요 조치
- [ ] NAS DSM 제어판 → 파일 서비스 → SMB → 고급 설정 확인
- [ ] Windows 탐색기에서 `\\10.10.100.122` 직접 접근 테스트
- [ ] 네트워크/인프라 담당자 에스컬레이션
