# Poker Hand Auto-Capture System - Docker Compose
# Deployment configuration for Synology NAS (DSM 7.2+)
#
# Quick Start:
#   1. ./install.sh (NAS SSH) 또는 deploy-to-nas.ps1 (Windows)
#   2. PokerGFX에서 JSON 출력 경로를 \\NAS_IP\docker\pokergfx\hands\ 로 설정
#
# Manual Setup:
#   1. Copy this file to /volume1/docker/poker-capture/
#   2. Create .env file: echo "DB_PASSWORD=yourpass" > .env
#   3. Run: docker-compose up -d --build
#
# Folder structure:
#   /volume1/docker/
#   ├── poker-capture/
#   │   ├── app/           # Application code
#   │   ├── data/          # Processed files DB, logs
#   │   └── docker-compose.yml
#   ├── postgresql/
#   │   └── data/          # PostgreSQL persistence
#   └── pokergfx/
#       └── hands/         # JSON files from PokerGFX (SMB shared)

version: "3.8"

services:
  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  db:
    container_name: poker-db
    image: postgres:16-alpine
    mem_limit: 512m
    cpu_shares: 768
    environment:
      POSTGRES_USER: poker
      POSTGRES_PASSWORD: ${DB_PASSWORD:?DB_PASSWORD is required}
      POSTGRES_DB: poker_hands
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - /volume1/docker/postgresql/data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U poker -d poker_hands"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - poker-network

  # =============================================================================
  # Poker Hand Capture System
  # =============================================================================
  # NOTE: network_mode: host 사용 이유
  # Synology NAS Docker에서 bridge 네트워크로는 db 서비스에 접근 불가
  # - 서비스명 'db' DNS 해석 안 됨 (별도 compose 실행 시)
  # - host.docker.internal 미지원 (Synology 제한)
  # - 해결책: host 네트워크로 127.0.0.1:5432 직접 접근
  # =============================================================================
  poker-capture:
    container_name: poker-capture
    build:
      context: ./app
      dockerfile: Dockerfile
    mem_limit: 256m
    cpu_shares: 512
    network_mode: host
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Primary Source Mode
      - POKERGFX_MODE=json
      - POKERGFX_JSON_PATH=/watch
      - POKERGFX_POLLING_INTERVAL=2.0
      - POKERGFX_PROCESSED_DB=/app/data/processed_files.json
      - POKERGFX_FILE_PATTERN=*.json

      # Database Connection (host network: use localhost)
      - DB_HOST=127.0.0.1
      - DB_PORT=5432
      - DB_NAME=poker_hands
      - DB_USER=poker
      - DB_PASSWORD=${DB_PASSWORD}

      # Secondary Source (Gemini AI) - Optional
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=gemini-2.5-flash-native-audio-preview

      # vMix Recording - Optional
      - VMIX_HOST=${VMIX_HOST:-127.0.0.1}
      - VMIX_PORT=${VMIX_PORT:-8088}
      - VMIX_AUTO_RECORD=${VMIX_AUTO_RECORD:-false}

      # Fallback
      - FALLBACK_ENABLED=true

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # JSON file input folder (read-only from PokerGFX)
      - /volume1/docker/pokergfx/hands:/watch:ro
      # Application data (processed files DB, logs)
      - /volume1/docker/poker-capture/data:/app/data
    restart: unless-stopped
    # NOTE: network_mode: host와 networks는 함께 사용 불가
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =============================================================================
  # pgAdmin (Optional - Database Management UI)
  # =============================================================================
  pgadmin:
    container_name: poker-pgadmin
    image: dpage/pgadmin4:latest
    mem_limit: 256m
    cpu_shares: 256
    profiles:
      - admin  # Only starts with: docker-compose --profile admin up -d
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@poker.local}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:?PGADMIN_PASSWORD is required}
      PGADMIN_LISTEN_PORT: 5050
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:5050"
    volumes:
      - /volume1/docker/poker-capture/pgadmin:/var/lib/pgadmin
    restart: unless-stopped
    networks:
      - poker-network
    depends_on:
      - db

  # =============================================================================
  # Metabase (Optional - Analytics Dashboard)
  # PRD-0005 참조: 플레이어 통계 시각화 (VPIP/PFR, Chip Flow, Pot Distribution)
  # =============================================================================
  metabase:
    container_name: poker-metabase
    image: metabase/metabase:latest
    mem_limit: 1g
    cpu_shares: 512
    profiles:
      - analytics  # Only starts with: docker-compose --profile analytics up -d
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: poker_hands
      MB_DB_PORT: 5432
      MB_DB_USER: poker
      MB_DB_PASS: ${DB_PASSWORD}
      MB_DB_HOST: db
      MB_SITE_NAME: "Poker Analytics"
      JAVA_TIMEZONE: Asia/Seoul
    ports:
      - "3000:3000"
    volumes:
      - /volume1/docker/poker-capture/metabase:/metabase-data
    restart: unless-stopped
    networks:
      - poker-network
    depends_on:
      db:
        condition: service_healthy

networks:
  poker-network:
    driver: bridge
